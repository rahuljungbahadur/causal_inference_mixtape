<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.37">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Rahul bahadur">

<title>Matching and Sub-Classification</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="chp_05_Matching_subClassification_files/libs/clipboard/clipboard.min.js"></script>
<script src="chp_05_Matching_subClassification_files/libs/quarto-html/quarto.js"></script>
<script src="chp_05_Matching_subClassification_files/libs/quarto-html/popper.min.js"></script>
<script src="chp_05_Matching_subClassification_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="chp_05_Matching_subClassification_files/libs/quarto-html/anchor.min.js"></script>
<link href="chp_05_Matching_subClassification_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="chp_05_Matching_subClassification_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="chp_05_Matching_subClassification_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="chp_05_Matching_subClassification_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="chp_05_Matching_subClassification_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#bias-correction" id="toc-bias-correction" class="nav-link active" data-scroll-target="#bias-correction">Bias Correction:</a>
  <ul class="collapse">
  <li><a href="#steps-for-bias-correction" id="toc-steps-for-bias-correction" class="nav-link" data-scroll-target="#steps-for-bias-correction">Steps for Bias correction</a></li>
  <li><a href="#computing-the-variance-of-the-bias-estimator" id="toc-computing-the-variance-of-the-bias-estimator" class="nav-link" data-scroll-target="#computing-the-variance-of-the-bias-estimator">Computing the variance of the bias estimator</a></li>
  </ul></li>
  <li><a href="#the-nsw-program" id="toc-the-nsw-program" class="nav-link" data-scroll-target="#the-nsw-program">The NSW Program</a>
  <ul class="collapse">
  <li><a href="#some-exploratory-analysis-for-re78" id="toc-some-exploratory-analysis-for-re78" class="nav-link" data-scroll-target="#some-exploratory-analysis-for-re78">Some exploratory analysis for re78</a></li>
  <li><a href="#read-in-cps-data" id="toc-read-in-cps-data" class="nav-link" data-scroll-target="#read-in-cps-data">Read in CPS data</a></li>
  <li><a href="#diff-in-distribution-of-the-2-groups" id="toc-diff-in-distribution-of-the-2-groups" class="nav-link" data-scroll-target="#diff-in-distribution-of-the-2-groups">Diff in distribution of the 2 groups</a></li>
  <li><a href="#plot-the-dist-of-the-propensities" id="toc-plot-the-dist-of-the-propensities" class="nav-link" data-scroll-target="#plot-the-dist-of-the-propensities">Plot the dist of the propensities</a>
  <ul class="collapse">
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion:</a></li>
  </ul></li>
  <li><a href="#comnparing-with-r-data" id="toc-comnparing-with-r-data" class="nav-link" data-scroll-target="#comnparing-with-r-data">Comnparing with R data</a>
  <ul class="collapse">
  <li><a href="#computing-propensity-scores" id="toc-computing-propensity-scores" class="nav-link" data-scroll-target="#computing-propensity-scores">Computing propensity scores</a></li>
  <li><a href="#conclusion-1" id="toc-conclusion-1" class="nav-link" data-scroll-target="#conclusion-1">Conclusion:</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#weighing-on-propensity-score" id="toc-weighing-on-propensity-score" class="nav-link" data-scroll-target="#weighing-on-propensity-score">Weighing on propensity score</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Matching and Sub-Classification</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Rahul bahadur </p>
          </div>
  </div>
    
    
  </div>
  

</header>

<div class="cell" data-execution_count="1">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> smf </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> combinations </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotnine <span class="im">as</span> p</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># read data</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ssl</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>ssl._create_default_https_context <span class="op">=</span> ssl._create_unverified_context</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_data(<span class="bu">file</span>): </span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.read_stata(<span class="st">"https://raw.github.com/scunning1975/mixtape/master/"</span> <span class="op">+</span> <span class="bu">file</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>nsw_dw <span class="op">=</span> read_data(<span class="st">'nsw_mixtape.dta'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="bias-correction" class="level1">
<h1>Bias Correction:</h1>
<p>Causal inference relies on finding the identical twin that was exposed to the treatment for the one which was not or vice-versa. However, that is not always possible. If the covariates are not exactly the same then matching them would lead to biases. This bias can be corrected as shown below.</p>
<div class="cell" data-execution_count="2">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> smf </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> combinations </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotnine <span class="im">as</span> p</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ssl</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="3">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read data</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>ssl._create_default_https_context <span class="op">=</span> ssl._create_unverified_context</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_data(<span class="bu">file</span>): </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.read_stata(<span class="st">"https://raw.github.com/scunning1975/mixtape/master/"</span> <span class="op">+</span> <span class="bu">file</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>training_bias_reduction <span class="op">=</span> read_data(<span class="st">"training_bias_reduction.dta"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="4">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>training_bias_reduction</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="4">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Unit</th>
      <th>Y</th>
      <th>D</th>
      <th>X</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>5</td>
      <td>1</td>
      <td>11</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>2</td>
      <td>1</td>
      <td>7</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>10</td>
      <td>1</td>
      <td>5</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>6</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>4</td>
      <td>0</td>
      <td>10</td>
    </tr>
    <tr>
      <th>5</th>
      <td>6</td>
      <td>0</td>
      <td>0</td>
      <td>8</td>
    </tr>
    <tr>
      <th>6</th>
      <td>7</td>
      <td>5</td>
      <td>0</td>
      <td>4</td>
    </tr>
    <tr>
      <th>7</th>
      <td>8</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<section id="steps-for-bias-correction" class="level2">
<h2 class="anchored" data-anchor-id="steps-for-bias-correction">Steps for Bias correction</h2>
<pre><code>1. Find the closest matching unit with the treatment unit based on the covariate (IV). For eg. for `Unit` 1 with X=11, the matching un-treated unit is X=10, i.e. `Unit` 5. Similarly for others</code></pre>
<div class="cell" data-execution_count="5">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>training_bias_reduction[<span class="st">'Y1'</span>] <span class="op">=</span> np.where(training_bias_reduction.D<span class="op">==</span><span class="dv">1</span>, training_bias_reduction.Y, <span class="dv">0</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>training_bias_reduction[<span class="st">'Y0'</span>] <span class="op">=</span> np.where(training_bias_reduction.D<span class="op">==</span><span class="dv">0</span>, training_bias_reduction.Y, <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<pre><code>2. Create a column with the fitted data using a model for `Y ~ X`</code></pre>
<div class="cell" data-execution_count="6">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>fitted_model <span class="op">=</span> sm.OLS.from_formula(<span class="st">'Y ~ X'</span>, training_bias_reduction).fit()</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>training_bias_reduction[<span class="st">'fitted'</span>] <span class="op">=</span>  fitted_model.predict(training_bias_reduction.X)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>training_bias_reduction</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="6">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Unit</th>
      <th>Y</th>
      <th>D</th>
      <th>X</th>
      <th>Y1</th>
      <th>Y0</th>
      <th>fitted</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>5</td>
      <td>1</td>
      <td>11</td>
      <td>5</td>
      <td>0</td>
      <td>3.888071</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>2</td>
      <td>1</td>
      <td>7</td>
      <td>2</td>
      <td>0</td>
      <td>4.082474</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>10</td>
      <td>1</td>
      <td>5</td>
      <td>10</td>
      <td>0</td>
      <td>4.179676</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>6</td>
      <td>1</td>
      <td>3</td>
      <td>6</td>
      <td>0</td>
      <td>4.276878</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>4</td>
      <td>0</td>
      <td>10</td>
      <td>0</td>
      <td>4</td>
      <td>3.936672</td>
    </tr>
    <tr>
      <th>5</th>
      <td>6</td>
      <td>0</td>
      <td>0</td>
      <td>8</td>
      <td>0</td>
      <td>0</td>
      <td>4.033873</td>
    </tr>
    <tr>
      <th>6</th>
      <td>7</td>
      <td>5</td>
      <td>0</td>
      <td>4</td>
      <td>0</td>
      <td>5</td>
      <td>4.228277</td>
    </tr>
    <tr>
      <th>7</th>
      <td>8</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>4.374080</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>Bias := it is the diff in the predicted values generated based on the covariates.` implying that, given the same model, and the same set of covariates, and no information on which units</p>
<p>are treated or not, the model should generate fitted values consistent with these assumptions.</p>
<p>Bias reduction method := It is the diff between the diff of <code>Treated</code> and <code>Un-Treated</code> covariate and the diff between <code>Treated</code> predicted value and <code>un_treated</code> predicted value</p>
<div class="cell" data-execution_count="7">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>ATT <span class="op">=</span> np.mean((np.array(training_bias_reduction[<span class="st">'Y'</span>][training_bias_reduction.D<span class="op">==</span><span class="dv">1</span>]) <span class="op">-</span> np.array(training_bias_reduction[<span class="st">'Y'</span>][training_bias_reduction.D<span class="op">==</span><span class="dv">0</span>])) <span class="op">-</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a> (np.array(training_bias_reduction[<span class="st">'fitted'</span>][training_bias_reduction.D<span class="op">==</span><span class="dv">1</span>]) <span class="op">-</span> np.array(training_bias_reduction[<span class="st">'fitted'</span>][training_bias_reduction.D<span class="op">==</span><span class="dv">0</span>])))</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ATT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>3.2864506627393233</code></pre>
</div>
</div>
</section>
<section id="computing-the-variance-of-the-bias-estimator" class="level2">
<h2 class="anchored" data-anchor-id="computing-the-variance-of-the-bias-estimator">Computing the variance of the bias estimator</h2>
<p><span class="math display">\[
\sigma^2_{ATT} = \frac{1}{N_T} \sum_{D_i=1}(Y_i - \frac{1}{M} \sum_{M_i=1}^{M} {Y_{j_{(m)}i} - \hat{\delta}_{ATT}})^2
\]</span></p>
<div class="cell" data-execution_count="8">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>var_att <span class="op">=</span> (((np.array(training_bias_reduction.Y[training_bias_reduction.D<span class="op">==</span><span class="dv">1</span>]) <span class="op">-</span> np.array(training_bias_reduction.Y[training_bias_reduction.D<span class="op">==</span><span class="dv">0</span>]) <span class="op">-</span> ATT)) <span class="op">**</span><span class="dv">2</span>).mean()</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>var_att, np.sqrt(var_att)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>(3.188828650814136, 1.7857291650231106)</code></pre>
</div>
</div>
</section>
</section>
<section id="the-nsw-program" class="level1">
<h1>The NSW Program</h1>
<div class="cell" data-execution_count="9">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read data</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>ssl._create_default_https_context <span class="op">=</span> ssl._create_unverified_context</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_data(<span class="bu">file</span>): </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.read_stata(<span class="st">"https://raw.github.com/scunning1975/mixtape/master/"</span> <span class="op">+</span> <span class="bu">file</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>nsw_dw <span class="op">=</span> read_data(<span class="st">'nsw_mixtape.dta'</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>nsw_dw</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="9">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>data_id</th>
      <th>treat</th>
      <th>age</th>
      <th>educ</th>
      <th>black</th>
      <th>hisp</th>
      <th>marr</th>
      <th>nodegree</th>
      <th>re74</th>
      <th>re75</th>
      <th>re78</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Dehejia-Wahba Sample</td>
      <td>1.0</td>
      <td>37.0</td>
      <td>11.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>9930.045898</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Dehejia-Wahba Sample</td>
      <td>1.0</td>
      <td>22.0</td>
      <td>9.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>3595.894043</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Dehejia-Wahba Sample</td>
      <td>1.0</td>
      <td>30.0</td>
      <td>12.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>24909.449219</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Dehejia-Wahba Sample</td>
      <td>1.0</td>
      <td>27.0</td>
      <td>11.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>7506.145996</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Dehejia-Wahba Sample</td>
      <td>1.0</td>
      <td>33.0</td>
      <td>8.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>289.789886</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>440</th>
      <td>Dehejia-Wahba Sample</td>
      <td>0.0</td>
      <td>21.0</td>
      <td>9.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>31886.429688</td>
      <td>12357.219727</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>441</th>
      <td>Dehejia-Wahba Sample</td>
      <td>0.0</td>
      <td>28.0</td>
      <td>11.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>17491.449219</td>
      <td>13371.250000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>442</th>
      <td>Dehejia-Wahba Sample</td>
      <td>0.0</td>
      <td>29.0</td>
      <td>9.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>9594.307617</td>
      <td>16341.160156</td>
      <td>16900.300781</td>
    </tr>
    <tr>
      <th>443</th>
      <td>Dehejia-Wahba Sample</td>
      <td>0.0</td>
      <td>25.0</td>
      <td>9.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>24731.619141</td>
      <td>16946.630859</td>
      <td>7343.963867</td>
    </tr>
    <tr>
      <th>444</th>
      <td>Dehejia-Wahba Sample</td>
      <td>0.0</td>
      <td>22.0</td>
      <td>10.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>25720.919922</td>
      <td>23031.980469</td>
      <td>5448.800781</td>
    </tr>
  </tbody>
</table>
<p>445 rows × 11 columns</p>
</div>
</div>
</div>
<section id="some-exploratory-analysis-for-re78" class="level2">
<h2 class="anchored" data-anchor-id="some-exploratory-analysis-for-re78">Some exploratory analysis for re78</h2>
<div class="cell" data-execution_count="10">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>nsw_dw[<span class="st">'treat2'</span>] <span class="op">=</span> nsw_dw.treat.astype(<span class="bu">str</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>(p.ggplot(nsw_dw, p.aes(x<span class="op">=</span><span class="st">'re78'</span>, fill <span class="op">=</span> <span class="st">'treat2'</span>)) <span class="op">+</span> p.geom_histogram(alpha<span class="op">=</span><span class="fl">0.8</span>, position<span class="op">=</span><span class="st">'dodge2'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\usbahadura\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.9_qbz5n2kfra8p0\LocalCache\local-packages\Python39\site-packages\plotnine\stats\stat_bin.py:95: PlotnineWarning: 'stat_bin()' using 'bins = 29'. Pick better value with 'binwidth'.</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="chp_05_Matching_subClassification_files/figure-html/cell-11-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>&lt;ggplot: (85509675210)&gt;</code></pre>
</div>
</div>
<div class="cell" data-execution_count="11">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>mean1 <span class="op">=</span> nsw_dw[nsw_dw.treat<span class="op">==</span><span class="dv">1</span>].re78.mean()</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>mean0 <span class="op">=</span> nsw_dw[nsw_dw.treat<span class="op">==</span><span class="dv">0</span>].re78.mean()</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>ate <span class="op">=</span> mean1 <span class="op">-</span> mean0</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"The experimental ATE estimate is </span><span class="sc">{:.2f}</span><span class="st">"</span>.<span class="bu">format</span>(ate))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>The experimental ATE estimate is 1794.34</code></pre>
</div>
</div>
</section>
<section id="read-in-cps-data" class="level2">
<h2 class="anchored" data-anchor-id="read-in-cps-data">Read in CPS data</h2>
<p>This data will act as counterfactual. Of course, it cannot serve as the exact counterfactual of the nsw program people as CPS is random americans (no treatment) whereas NSW are the distressed people who were considered as candidates for the program.</p>
<div class="cell" data-execution_count="12">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>ssl._create_default_https_context <span class="op">=</span> ssl._create_unverified_context</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_data(<span class="bu">file</span>): </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.read_stata(<span class="st">"https://raw.github.com/scunning1975/mixtape/master/"</span> <span class="op">+</span> <span class="bu">file</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data for logit </span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>nsw_dw_cpscontrol <span class="op">=</span> read_data(<span class="st">'cps_mixtape.dta'</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>nsw_dw_cpscontrol</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="12">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>data_id</th>
      <th>treat</th>
      <th>age</th>
      <th>educ</th>
      <th>black</th>
      <th>hisp</th>
      <th>marr</th>
      <th>nodegree</th>
      <th>re74</th>
      <th>re75</th>
      <th>re78</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>CPS1</td>
      <td>0</td>
      <td>45</td>
      <td>11</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>21516.669922</td>
      <td>25243.550781</td>
      <td>25564.669922</td>
    </tr>
    <tr>
      <th>1</th>
      <td>CPS1</td>
      <td>0</td>
      <td>21</td>
      <td>14</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>3175.970947</td>
      <td>5852.564941</td>
      <td>13496.080078</td>
    </tr>
    <tr>
      <th>2</th>
      <td>CPS1</td>
      <td>0</td>
      <td>38</td>
      <td>12</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>23039.019531</td>
      <td>25130.759766</td>
      <td>25564.669922</td>
    </tr>
    <tr>
      <th>3</th>
      <td>CPS1</td>
      <td>0</td>
      <td>48</td>
      <td>6</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>24994.369141</td>
      <td>25243.550781</td>
      <td>25564.669922</td>
    </tr>
    <tr>
      <th>4</th>
      <td>CPS1</td>
      <td>0</td>
      <td>18</td>
      <td>8</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>1669.295044</td>
      <td>10727.610352</td>
      <td>9860.869141</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>15987</th>
      <td>CPS1</td>
      <td>0</td>
      <td>22</td>
      <td>12</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>3975.352051</td>
      <td>6801.435059</td>
      <td>2757.437988</td>
    </tr>
    <tr>
      <th>15988</th>
      <td>CPS1</td>
      <td>0</td>
      <td>20</td>
      <td>12</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1445.938965</td>
      <td>11832.240234</td>
      <td>6895.071777</td>
    </tr>
    <tr>
      <th>15989</th>
      <td>CPS1</td>
      <td>0</td>
      <td>37</td>
      <td>12</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1733.951050</td>
      <td>1559.370972</td>
      <td>4221.865234</td>
    </tr>
    <tr>
      <th>15990</th>
      <td>CPS1</td>
      <td>0</td>
      <td>47</td>
      <td>9</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>16914.349609</td>
      <td>11384.660156</td>
      <td>13671.929688</td>
    </tr>
    <tr>
      <th>15991</th>
      <td>CPS1</td>
      <td>0</td>
      <td>40</td>
      <td>10</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>13628.660156</td>
      <td>13144.549805</td>
      <td>7979.724121</td>
    </tr>
  </tbody>
</table>
<p>15992 rows × 11 columns</p>
</div>
</div>
</div>
<p>Concatenating both datasets</p>
<div class="cell" data-execution_count="13">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>nsw_dw_cpscontrol[<span class="st">'treat2'</span>] <span class="op">=</span> nsw_dw_cpscontrol.treat.astype(<span class="bu">float</span>).astype(<span class="bu">str</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>nsw_all <span class="op">=</span> pd.concat([nsw_dw, nsw_dw_cpscontrol], axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>nsw_all</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="13">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>data_id</th>
      <th>treat</th>
      <th>age</th>
      <th>educ</th>
      <th>black</th>
      <th>hisp</th>
      <th>marr</th>
      <th>nodegree</th>
      <th>re74</th>
      <th>re75</th>
      <th>re78</th>
      <th>treat2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Dehejia-Wahba Sample</td>
      <td>1.0</td>
      <td>37.0</td>
      <td>11.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>9930.045898</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Dehejia-Wahba Sample</td>
      <td>1.0</td>
      <td>22.0</td>
      <td>9.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>3595.894043</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Dehejia-Wahba Sample</td>
      <td>1.0</td>
      <td>30.0</td>
      <td>12.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>24909.449219</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Dehejia-Wahba Sample</td>
      <td>1.0</td>
      <td>27.0</td>
      <td>11.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>7506.145996</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Dehejia-Wahba Sample</td>
      <td>1.0</td>
      <td>33.0</td>
      <td>8.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>289.789886</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>15987</th>
      <td>CPS1</td>
      <td>0.0</td>
      <td>22.0</td>
      <td>12.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>3975.352051</td>
      <td>6801.435059</td>
      <td>2757.437988</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>15988</th>
      <td>CPS1</td>
      <td>0.0</td>
      <td>20.0</td>
      <td>12.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1445.938965</td>
      <td>11832.240234</td>
      <td>6895.071777</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>15989</th>
      <td>CPS1</td>
      <td>0.0</td>
      <td>37.0</td>
      <td>12.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1733.951050</td>
      <td>1559.370972</td>
      <td>4221.865234</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>15990</th>
      <td>CPS1</td>
      <td>0.0</td>
      <td>47.0</td>
      <td>9.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>16914.349609</td>
      <td>11384.660156</td>
      <td>13671.929688</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>15991</th>
      <td>CPS1</td>
      <td>0.0</td>
      <td>40.0</td>
      <td>10.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>13628.660156</td>
      <td>13144.549805</td>
      <td>7979.724121</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>16437 rows × 12 columns</p>
</div>
</div>
</div>
</section>
<section id="diff-in-distribution-of-the-2-groups" class="level2">
<h2 class="anchored" data-anchor-id="diff-in-distribution-of-the-2-groups">Diff in distribution of the 2 groups</h2>
<div class="cell" data-execution_count="14">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>(p.ggplot(nsw_all, p.aes(x<span class="op">=</span><span class="st">'age'</span>)) <span class="op">+</span> p.geom_density(alpha<span class="op">=</span><span class="fl">0.5</span>) <span class="op">+</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a> p.facet_wrap(<span class="st">'~treat2 + data_id'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="chp_05_Matching_subClassification_files/figure-html/cell-15-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>&lt;ggplot: (85607019605)&gt;</code></pre>
</div>
</div>
<p>As seen in the plot, the distribution of the non-treated group between the 2 studies is very different.</p>
<p>Next step would be to find the propensity of the people in the <code>CPS</code> study to lie in the <code>NSW</code> study</p>
<p>Since the data for <code>re74</code> and <code>re75</code> are 0.0 where no observation was recorded, we would need to create another variable indicating that the values are missing and should not be interpreted as <code>0.0</code></p>
<div class="cell" data-execution_count="15">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>nsw_all[<span class="st">'u74'</span>], nsw_all[<span class="st">'u75'</span>] <span class="op">=</span> <span class="dv">0</span>, <span class="dv">0</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>nsw_all.loc[nsw_all.re74<span class="op">==</span><span class="dv">0</span>, <span class="st">'u74'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>nsw_all.loc[nsw_all.re75<span class="op">==</span><span class="dv">0</span>, <span class="st">'u75'</span>] <span class="op">=</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="16">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> smf.glm(formula<span class="op">=</span><span class="st">"""treat ~ age + I(age**2) + I(age**3) + educ + I(educ**2) + </span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="st">                    marr + nodegree + black + hisp + re74 + re75+ u74 + u75 + educ*re74"""</span>, </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>                    family<span class="op">=</span>sm.families.Binomial(),</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>                   data<span class="op">=</span>nsw_all).fit()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="17">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="17">

<table class="simpletable">
<caption>Generalized Linear Model Regression Results</caption>
<tbody><tr>
  <th>Dep. Variable:</th>         <td>treat</td>      <th>  No. Observations:  </th>  <td> 16437</td> 
</tr>
<tr>
  <th>Model:</th>                  <td>GLM</td>       <th>  Df Residuals:      </th>  <td> 16422</td> 
</tr>
<tr>
  <th>Model Family:</th>        <td>Binomial</td>     <th>  Df Model:          </th>  <td>    14</td> 
</tr>
<tr>
  <th>Link Function:</th>         <td>Logit</td>      <th>  Scale:             </th> <td>  1.0000</td>
</tr>
<tr>
  <th>Method:</th>                <td>IRLS</td>       <th>  Log-Likelihood:    </th> <td> -532.97</td>
</tr>
<tr>
  <th>Date:</th>            <td>Wed, 03 Aug 2022</td> <th>  Deviance:          </th> <td>  1065.9</td>
</tr>
<tr>
  <th>Time:</th>                <td>16:42:03</td>     <th>  Pearson chi2:      </th> <td>4.68e+03</td>
</tr>
<tr>
  <th>No. Iterations:</th>         <td>11</td>        <th>  Pseudo R-squ. (CS):</th>  <td>0.05685</td>
</tr>
<tr>
  <th>Covariance Type:</th>     <td>nonrobust</td>    <th>                     </th>     <td> </td>   
</tr>
</tbody></table>
<table class="simpletable">
<tbody><tr>
        <td></td>          <th>coef</th>     <th>std err</th>      <th>z</th>      <th>P&gt;|z|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th>    <td>  -20.1283</td> <td>    3.234</td> <td>   -6.224</td> <td> 0.000</td> <td>  -26.467</td> <td>  -13.790</td>
</tr>
<tr>
  <th>age</th>          <td>    1.2369</td> <td>    0.307</td> <td>    4.027</td> <td> 0.000</td> <td>    0.635</td> <td>    1.839</td>
</tr>
<tr>
  <th>I(age ** 2)</th>  <td>   -0.0335</td> <td>    0.010</td> <td>   -3.382</td> <td> 0.001</td> <td>   -0.053</td> <td>   -0.014</td>
</tr>
<tr>
  <th>I(age ** 3)</th>  <td>    0.0003</td> <td>    0.000</td> <td>    2.703</td> <td> 0.007</td> <td> 7.51e-05</td> <td>    0.000</td>
</tr>
<tr>
  <th>educ</th>         <td>    0.5070</td> <td>    0.217</td> <td>    2.334</td> <td> 0.020</td> <td>    0.081</td> <td>    0.933</td>
</tr>
<tr>
  <th>I(educ ** 2)</th> <td>   -0.0333</td> <td>    0.012</td> <td>   -2.861</td> <td> 0.004</td> <td>   -0.056</td> <td>   -0.010</td>
</tr>
<tr>
  <th>marr</th>         <td>   -0.9170</td> <td>    0.226</td> <td>   -4.053</td> <td> 0.000</td> <td>   -1.360</td> <td>   -0.474</td>
</tr>
<tr>
  <th>nodegree</th>     <td>    0.1493</td> <td>    0.284</td> <td>    0.525</td> <td> 0.600</td> <td>   -0.408</td> <td>    0.707</td>
</tr>
<tr>
  <th>black</th>        <td>    3.2811</td> <td>    0.266</td> <td>   12.338</td> <td> 0.000</td> <td>    2.760</td> <td>    3.802</td>
</tr>
<tr>
  <th>hisp</th>         <td>    1.6077</td> <td>    0.395</td> <td>    4.072</td> <td> 0.000</td> <td>    0.834</td> <td>    2.381</td>
</tr>
<tr>
  <th>re74</th>         <td>-8.049e-05</td> <td> 8.74e-05</td> <td>   -0.921</td> <td> 0.357</td> <td>   -0.000</td> <td> 9.09e-05</td>
</tr>
<tr>
  <th>re75</th>         <td>   -0.0002</td> <td>  3.5e-05</td> <td>   -4.906</td> <td> 0.000</td> <td>   -0.000</td> <td>   -0.000</td>
</tr>
<tr>
  <th>u74</th>          <td>    1.0865</td> <td>    0.270</td> <td>    4.028</td> <td> 0.000</td> <td>    0.558</td> <td>    1.615</td>
</tr>
<tr>
  <th>u75</th>          <td>   -0.3577</td> <td>    0.235</td> <td>   -1.522</td> <td> 0.128</td> <td>   -0.818</td> <td>    0.103</td>
</tr>
<tr>
  <th>educ:re74</th>    <td> 8.285e-06</td> <td> 7.54e-06</td> <td>    1.099</td> <td> 0.272</td> <td>-6.49e-06</td> <td> 2.31e-05</td>
</tr>
</tbody></table>
</div>
</div>
<div class="cell" data-execution_count="18">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>propensity <span class="op">=</span> model.predict(nsw_all)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>nsw_all[<span class="st">'propensity'</span>] <span class="op">=</span> propensity</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>nsw_all[[<span class="st">'treat'</span>, <span class="st">'propensity'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="18">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>treat</th>
      <th>propensity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1.0</td>
      <td>0.161451</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.0</td>
      <td>0.131545</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.0</td>
      <td>0.370723</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.0</td>
      <td>0.476099</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1.0</td>
      <td>0.517290</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>15987</th>
      <td>0.0</td>
      <td>0.059495</td>
    </tr>
    <tr>
      <th>15988</th>
      <td>0.0</td>
      <td>0.006904</td>
    </tr>
    <tr>
      <th>15989</th>
      <td>0.0</td>
      <td>0.004572</td>
    </tr>
    <tr>
      <th>15990</th>
      <td>0.0</td>
      <td>0.000171</td>
    </tr>
    <tr>
      <th>15991</th>
      <td>0.0</td>
      <td>0.000775</td>
    </tr>
  </tbody>
</table>
<p>16437 rows × 2 columns</p>
</div>
</div>
</div>
</section>
<section id="plot-the-dist-of-the-propensities" class="level2">
<h2 class="anchored" data-anchor-id="plot-the-dist-of-the-propensities">Plot the dist of the propensities</h2>
<div class="cell" data-execution_count="19">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>(p.ggplot(nsw_all, p.aes(x<span class="op">=</span><span class="st">'propensity'</span>)) <span class="op">+</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a> p.geom_density(alpha<span class="op">=</span><span class="fl">0.4</span>) <span class="op">+</span> </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a> p.facet_wrap(<span class="st">'~ treat'</span>, scales<span class="op">=</span><span class="st">'free'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\usbahadura\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.9_qbz5n2kfra8p0\LocalCache\local-packages\Python39\site-packages\plotnine\facets\facet.py:390: PlotnineWarning: If you need more space for the x-axis tick text use ... + theme(subplots_adjust={'wspace': 0.25}). Choose an appropriate value for 'wspace'.</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="chp_05_Matching_subClassification_files/figure-html/cell-20-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>&lt;ggplot: (85512357473)&gt;</code></pre>
</div>
</div>
<div class="cell" data-execution_count="20">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>nsw_all.groupby(<span class="st">'treat'</span>)[<span class="st">'propensity'</span>].quantile([<span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">0.75</span>, <span class="fl">0.95</span>, <span class="fl">0.99</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>treat      
0.0    0.05    0.000012
       0.10    0.000021
       0.25    0.000068
       0.50    0.000354
       0.75    0.002162
       0.95    0.026261
       0.99    0.239938
1.0    0.05    0.007470
       0.10    0.020440
       0.25    0.097407
       0.50    0.193819
       0.75    0.310652
       0.95    0.510861
       0.99    0.569938
Name: propensity, dtype: float64</code></pre>
</div>
</div>
<div class="cell" data-execution_count="21">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm </span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> smf </span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> combinations </span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotnine <span class="im">as</span> p</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co"># read data</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ssl</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>ssl._create_default_https_context <span class="op">=</span> ssl._create_unverified_context</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_data(<span class="bu">file</span>): </span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.read_stata(<span class="st">"https://raw.github.com/scunning1975/mixtape/master/"</span> <span class="op">+</span> <span class="bu">file</span>)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data for logit </span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>nsw_dw_cpscontrol <span class="op">=</span> read_data(<span class="st">'cps_mixtape.dta'</span>)</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>nsw_dw_cpscontrol <span class="op">=</span> pd.concat((nsw_dw_cpscontrol, nsw_dw))</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>nsw_dw_cpscontrol[<span class="st">'u74'</span>], nsw_dw_cpscontrol[<span class="st">'u75'</span>] <span class="op">=</span> <span class="dv">0</span>, <span class="dv">0</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>nsw_dw_cpscontrol.loc[nsw_dw_cpscontrol.re74<span class="op">==</span><span class="dv">0</span>, <span class="st">'u74'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>nsw_dw_cpscontrol.loc[nsw_dw_cpscontrol.re75<span class="op">==</span><span class="dv">0</span>, <span class="st">'u75'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="co"># estimating propensity score</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>logit_nsw <span class="op">=</span> smf.glm(formula<span class="op">=</span><span class="st">"""treat ~ age + I(age**2) + I(age**3) + educ + I(educ**2) + </span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a><span class="st">                    marr + nodegree + black + hisp + re74 + re75 + u74 + u75 + educ*re74"""</span>, </span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>                    family<span class="op">=</span>sm.families.Binomial(),</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>                   data<span class="op">=</span>nsw_dw_cpscontrol).fit()</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>                  </span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>nsw_dw_cpscontrol[<span class="st">'pscore'</span>] <span class="op">=</span> logit_nsw.predict(nsw_dw_cpscontrol)</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>nsw_dw_cpscontrol.groupby(<span class="st">'treat'</span>)[<span class="st">'pscore'</span>].mean()</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>p.ggplot(nsw_dw_cpscontrol, p.aes(x<span class="op">=</span><span class="st">'pscore'</span>)) <span class="op">+</span>    p.geom_histogram(bins<span class="op">=</span><span class="dv">50</span>) <span class="op">+</span>    p.facet_wrap(<span class="st">"treat"</span>, scales<span class="op">=</span><span class="st">'free'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\usbahadura\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.9_qbz5n2kfra8p0\LocalCache\local-packages\Python39\site-packages\plotnine\facets\facet.py:390: PlotnineWarning: If you need more space for the x-axis tick text use ... + theme(subplots_adjust={'wspace': 0.25}). Choose an appropriate value for 'wspace'.</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="chp_05_Matching_subClassification_files/figure-html/cell-22-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>&lt;ggplot: (85514420083)&gt;</code></pre>
</div>
</div>
<div class="cell" data-execution_count="22">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>nsw_dw_cpscontrol.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>(16437, 15)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="23">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>nsw_dw_cpscontrol.groupby(<span class="st">'treat'</span>)[<span class="st">'pscore'</span>].quantile([<span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">0.75</span>, <span class="fl">0.95</span>, <span class="fl">0.99</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>treat      
0.0    0.05    0.000012
       0.10    0.000021
       0.25    0.000068
       0.50    0.000354
       0.75    0.002162
       0.95    0.026261
       0.99    0.239938
1.0    0.05    0.007470
       0.10    0.020440
       0.25    0.097407
       0.50    0.193819
       0.75    0.310652
       0.95    0.510861
       0.99    0.569938
Name: pscore, dtype: float64</code></pre>
</div>
</div>
<section id="conclusion" class="level3">
<h3 class="anchored" data-anchor-id="conclusion">Conclusion:</h3>
<p>Was not able to replicate what the mixtape book shows. Trying to replicate it using the NSW data provided by the <code>MatchIt</code> library in <code>R</code>.</p>
</section>
</section>
<section id="comnparing-with-r-data" class="level2">
<h2 class="anchored" data-anchor-id="comnparing-with-r-data">Comnparing with R data</h2>
<pre class="{r}"><code>library(tidyverse)
library(MatchIt)
library(reticulate)</code></pre>
<pre class="{r}"><code>lalonde_dataset &lt;- MatchIt::lalonde
head(lalonde_dataset)
tail(lalonde_dataset)
nrow(lalonde_dataset)
write_csv(lalonde_dataset %&gt;% tibble::rownames_to_column('study_name'), 'lalonde_dataset.csv')</code></pre>
<div class="cell" data-execution_count="24">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>lalonde_df <span class="op">=</span> pd.read_csv(<span class="st">"lalonde_dataset.csv"</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>lalonde_df.head()</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>lalonde_df[<span class="op">~</span>lalonde_df.study_name.<span class="bu">str</span>.contains(<span class="st">'NSW'</span>)].shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>(429, 10)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="25">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>lalonde_df.study_name.sample()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>129    NSW130
Name: study_name, dtype: object</code></pre>
</div>
</div>
<div class="cell" data-execution_count="26">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>lalonde_df[<span class="st">'study_name'</span>] <span class="op">=</span> lalonde_df.study_name.<span class="bu">str</span>.extract(<span class="st">'([A-Z]+)'</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>lalonde_df.head(<span class="dv">10</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>lalonde_df[<span class="st">'treat2'</span>] <span class="op">=</span> lalonde_df.treat.astype(<span class="bu">str</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="27">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>(p.ggplot(lalonde_df, p.aes(x<span class="op">=</span><span class="st">'re74'</span>, fill<span class="op">=</span><span class="st">'treat2'</span>)) <span class="op">+</span> p.geom_histogram(position<span class="op">=</span><span class="st">'dodge'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>) <span class="op">+</span> p.facet_wrap(<span class="st">'~study_name'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\usbahadura\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.9_qbz5n2kfra8p0\LocalCache\local-packages\Python39\site-packages\plotnine\stats\stat_bin.py:95: PlotnineWarning: 'stat_bin()' using 'bins = 19'. Pick better value with 'binwidth'.</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="chp_05_Matching_subClassification_files/figure-html/cell-28-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>&lt;ggplot: (85514434314)&gt;</code></pre>
</div>
</div>
<p>So, all control units are coming from PSID and all treated units are from NSW</p>
<div class="cell" data-execution_count="28">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>lalonde_df[<span class="st">'u74'</span>], lalonde_df[<span class="st">'u75'</span>] <span class="op">=</span> <span class="dv">0</span>, <span class="dv">0</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>lalonde_df.loc[lalonde_df.re74<span class="op">==</span><span class="dv">0</span>, <span class="st">'u74'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>lalonde_df.loc[lalonde_df.re75<span class="op">==</span><span class="dv">0</span>, <span class="st">'u75'</span>] <span class="op">=</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="29">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>model_lalonde <span class="op">=</span> smf.glm(formula<span class="op">=</span><span class="st">"""treat ~ age + I(age**2) + I(age**3) + educ + I(educ**2) + </span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="st">                    married + nodegree + race + re74 + re75+ u74 + u75 + educ*re74"""</span>, </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>                    family<span class="op">=</span>sm.families.Binomial(),</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>                   data<span class="op">=</span>lalonde_df).fit()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="30">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>model_lalonde.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="30">

<table class="simpletable">
<caption>Generalized Linear Model Regression Results</caption>
<tbody><tr>
  <th>Dep. Variable:</th>         <td>treat</td>      <th>  No. Observations:  </th>  <td>   614</td> 
</tr>
<tr>
  <th>Model:</th>                  <td>GLM</td>       <th>  Df Residuals:      </th>  <td>   599</td> 
</tr>
<tr>
  <th>Model Family:</th>        <td>Binomial</td>     <th>  Df Model:          </th>  <td>    14</td> 
</tr>
<tr>
  <th>Link Function:</th>         <td>Logit</td>      <th>  Scale:             </th> <td>  1.0000</td>
</tr>
<tr>
  <th>Method:</th>                <td>IRLS</td>       <th>  Log-Likelihood:    </th> <td> -193.34</td>
</tr>
<tr>
  <th>Date:</th>            <td>Wed, 03 Aug 2022</td> <th>  Deviance:          </th> <td>  386.68</td>
</tr>
<tr>
  <th>Time:</th>                <td>16:42:30</td>     <th>  Pearson chi2:      </th>  <td>  603.</td> 
</tr>
<tr>
  <th>No. Iterations:</th>          <td>6</td>        <th>  Pseudo R-squ. (CS):</th>  <td>0.4480</td> 
</tr>
<tr>
  <th>Covariance Type:</th>     <td>nonrobust</td>    <th>                     </th>     <td> </td>   
</tr>
</tbody></table>
<table class="simpletable">
<tbody><tr>
         <td></td>           <th>coef</th>     <th>std err</th>      <th>z</th>      <th>P&gt;|z|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th>      <td>  -29.1241</td> <td>    5.158</td> <td>   -5.646</td> <td> 0.000</td> <td>  -39.235</td> <td>  -19.014</td>
</tr>
<tr>
  <th>race[T.hispan]</th> <td>   -2.2542</td> <td>    0.438</td> <td>   -5.149</td> <td> 0.000</td> <td>   -3.112</td> <td>   -1.396</td>
</tr>
<tr>
  <th>race[T.white]</th>  <td>   -2.8714</td> <td>    0.319</td> <td>   -8.989</td> <td> 0.000</td> <td>   -3.498</td> <td>   -2.245</td>
</tr>
<tr>
  <th>age</th>            <td>    2.1979</td> <td>    0.475</td> <td>    4.623</td> <td> 0.000</td> <td>    1.266</td> <td>    3.130</td>
</tr>
<tr>
  <th>I(age ** 2)</th>    <td>   -0.0590</td> <td>    0.015</td> <td>   -3.929</td> <td> 0.000</td> <td>   -0.088</td> <td>   -0.030</td>
</tr>
<tr>
  <th>I(age ** 3)</th>    <td>    0.0005</td> <td>    0.000</td> <td>    3.218</td> <td> 0.001</td> <td>    0.000</td> <td>    0.001</td>
</tr>
<tr>
  <th>educ</th>           <td>    1.0445</td> <td>    0.324</td> <td>    3.223</td> <td> 0.001</td> <td>    0.409</td> <td>    1.680</td>
</tr>
<tr>
  <th>I(educ ** 2)</th>   <td>   -0.0578</td> <td>    0.018</td> <td>   -3.165</td> <td> 0.002</td> <td>   -0.094</td> <td>   -0.022</td>
</tr>
<tr>
  <th>married</th>        <td>   -1.4998</td> <td>    0.347</td> <td>   -4.320</td> <td> 0.000</td> <td>   -2.180</td> <td>   -0.819</td>
</tr>
<tr>
  <th>nodegree</th>       <td>    0.3429</td> <td>    0.444</td> <td>    0.773</td> <td> 0.440</td> <td>   -0.527</td> <td>    1.212</td>
</tr>
<tr>
  <th>re74</th>           <td>   -0.0001</td> <td>    0.000</td> <td>   -1.025</td> <td> 0.305</td> <td>   -0.000</td> <td>    0.000</td>
</tr>
<tr>
  <th>re75</th>           <td> 7.657e-05</td> <td> 5.63e-05</td> <td>    1.360</td> <td> 0.174</td> <td>-3.38e-05</td> <td>    0.000</td>
</tr>
<tr>
  <th>u74</th>            <td>    1.8076</td> <td>    0.379</td> <td>    4.775</td> <td> 0.000</td> <td>    1.066</td> <td>    2.549</td>
</tr>
<tr>
  <th>u75</th>            <td>    0.0747</td> <td>    0.354</td> <td>    0.211</td> <td> 0.833</td> <td>   -0.618</td> <td>    0.768</td>
</tr>
<tr>
  <th>educ:re74</th>      <td> 1.139e-05</td> <td> 1.09e-05</td> <td>    1.042</td> <td> 0.297</td> <td>   -1e-05</td> <td> 3.28e-05</td>
</tr>
</tbody></table>
</div>
</div>
<section id="computing-propensity-scores" class="level3">
<h3 class="anchored" data-anchor-id="computing-propensity-scores">Computing propensity scores</h3>
<div class="cell" data-execution_count="31">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>lalonde_df[<span class="st">'propensity'</span>] <span class="op">=</span> model_lalonde.predict(lalonde_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="32">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>lalonde_df.groupby(<span class="st">'treat'</span>)[<span class="st">'propensity'</span>].quantile([<span class="fl">0.05</span>,<span class="fl">0.10</span>,<span class="fl">0.25</span>,<span class="fl">0.50</span>,<span class="fl">0.75</span>,<span class="fl">0.95</span>,<span class="fl">0.99</span>])</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>(p.ggplot(lalonde_df, p.aes(x<span class="op">=</span><span class="st">'propensity'</span>, fill<span class="op">=</span><span class="st">'treat2'</span>)) <span class="op">+</span> p.geom_histogram(alpha<span class="op">=</span><span class="fl">0.5</span>) <span class="op">+</span> p.facet_wrap(<span class="st">'~treat2'</span>))</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>(p.ggplot(lalonde_df, p.aes(x<span class="op">=</span><span class="st">'propensity'</span>, fill<span class="op">=</span><span class="st">'treat2'</span>)) <span class="op">+</span> p.geom_density(alpha<span class="op">=</span><span class="fl">0.5</span>) <span class="op">+</span> p.facet_wrap(<span class="st">'~treat2'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="chp_05_Matching_subClassification_files/figure-html/cell-33-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>&lt;ggplot: (85515973407)&gt;</code></pre>
</div>
</div>
</section>
<section id="conclusion-1" class="level3">
<h3 class="anchored" data-anchor-id="conclusion-1">Conclusion:</h3>
<p>This works a lot better than the data shown in the book</p>
</section>
</section>
</section>
<section id="weighing-on-propensity-score" class="level1">
<h1>Weighing on propensity score</h1>
<p>Basically, the propensity score calcluated in the previous step can be used to ‘weight’ each unit.</p>
<p><span class="math display">\[
\hat{\delta}_{ATE} = \frac{1}{N} \sum_{i=1}^N Y_i . \frac{D_i - \hat{p}(X_i)}{\hat{p}(X_i). (1-\hat{p}(X_i))}
\]</span></p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>